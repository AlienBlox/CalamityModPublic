using CalamityMod.Buffs.Summon;
using CalamityMod.CalPlayer;
using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;
using System;
using Terraria;
using Terraria.ID;
using Terraria.ModLoader;
namespace CalamityMod.Projectiles.Summon
{
	public class PurpleButterfly : ModProjectile
	{
		public int dust = 3;

		public override void SetStaticDefaults()
		{
			DisplayName.SetDefault("Purple Butterfly");
			Main.projFrames[projectile.type] = 4;
			ProjectileID.Sets.MinionSacrificable[projectile.type] = true;
			ProjectileID.Sets.MinionTargettingFeature[projectile.type] = true;
		}

		public override void SetDefaults()
		{
			projectile.width = 30;
			projectile.height = 30;
			projectile.netImportant = true;
			projectile.friendly = true;
			projectile.ignoreWater = true;
			projectile.minionSlots = 0.5f;
			projectile.timeLeft = 18000;
			projectile.penetrate = -1;
			projectile.tileCollide = false;
			projectile.timeLeft *= 5;
			projectile.minion = true;
		}

		public override void AI()
		{
			Player player = Main.player[projectile.owner];
			CalamityPlayer modPlayer = player.Calamity();
			if (dust > 0)
			{
				projectile.Calamity().spawnedPlayerMinionDamageValue = player.MinionDamage();
				projectile.Calamity().spawnedPlayerMinionProjectileDamageValue = projectile.damage;
				int num226 = 36;
				for (int num227 = 0; num227 < num226; num227++)
				{
					Vector2 vector6 = Vector2.Normalize(projectile.velocity) * new Vector2((float)projectile.width / 2f, (float)projectile.height) * 0.5f;
					vector6 = vector6.RotatedBy((double)((float)(num227 - (num226 / 2 - 1)) * 6.28318548f / (float)num226), default) + projectile.Center;
					Vector2 vector7 = vector6 - projectile.Center;
					int num228 = Dust.NewDust(vector6 + vector7, 0, 0, 173, vector7.X, vector7.Y, 100, default, 1.8f);
					Main.dust[num228].noGravity = true;
				}
				dust--;
			}
			if (player.MinionDamage() != projectile.Calamity().spawnedPlayerMinionDamageValue)
			{
				int damage2 = (int)((float)projectile.Calamity().spawnedPlayerMinionProjectileDamageValue /
					projectile.Calamity().spawnedPlayerMinionDamageValue *
					player.MinionDamage());
				projectile.damage = damage2;
			}
			if (Math.Abs(projectile.velocity.X) > 0.2f)
			{
				projectile.spriteDirection = -projectile.direction;
			}
			projectile.rotation = projectile.velocity.X * 0.02f;
			projectile.frameCounter++;
			if (projectile.frameCounter > 6)
			{
				projectile.frame++;
				projectile.frameCounter = 0;
			}
			if (projectile.frame > 3)
			{
				projectile.frame = 0;
			}
			Lighting.AddLight(projectile.Center, 0.3f, 0f, 0.5f);
			projectile.ChargingMinionAI(1200f, 1500f, 2400f, 150f, 0, 30f, 18f, 9f, new Vector2(0f, -60f), 30f, 12f, true, true);
			bool flag64 = projectile.type == ModContent.ProjectileType<PurpleButterfly>();
			player.AddBuff(ModContent.BuffType<ResurrectionButterflyBuff>(), 3600);
			if (flag64)
			{
				if (player.dead)
				{
					modPlayer.resButterfly = false;
				}
				if (modPlayer.resButterfly)
				{
					projectile.timeLeft = 2;
				}
			}
		}

		public override bool PreDraw(SpriteBatch spriteBatch, Color lightColor)
		{
			SpriteEffects spriteEffects = projectile.spriteDirection == -1 ? SpriteEffects.FlipHorizontally : SpriteEffects.None;
			Texture2D texture2D13 = Main.projectileTexture[projectile.type];
			int num214 = Main.projectileTexture[projectile.type].Height / Main.projFrames[projectile.type];
			int y6 = num214 * projectile.frame;
			Main.spriteBatch.Draw(texture2D13, projectile.Center - Main.screenPosition + new Vector2(0f, projectile.gfxOffY), new Microsoft.Xna.Framework.Rectangle?(new Rectangle(0, y6, texture2D13.Width, num214)), projectile.GetAlpha(lightColor), projectile.rotation, new Vector2((float)texture2D13.Width / 2f, (float)num214 / 2f), projectile.scale, spriteEffects, 0f);
			return false;
		}

		public override void OnHitNPC(NPC target, int damage, float knockback, bool crit)
		{
			target.immune[projectile.owner] = 8;
		}
	}
}
